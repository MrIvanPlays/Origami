From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <spottedleaf@spottedleaf.dev>
Date: Fri, 17 Jul 2020 09:22:54 +0300
Subject: [PATCH] Fix AdvancementPlayerData leak


diff --git a/src/main/java/net/minecraft/server/AdvancementDataPlayer.java b/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
index d3387a4e16f81b820d40502d2c46ebb3db88f824..0131bc39e8f8504a8f5e1bef74a9f65b87690169 100644
--- a/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
+++ b/src/main/java/net/minecraft/server/AdvancementDataPlayer.java
@@ -51,6 +51,8 @@ public class AdvancementDataPlayer {
     private Advancement l;
     private boolean m = true;
 
+    final Map<CriterionTriggerAbstract, Set<CriterionTrigger.a>> criterionData = Maps.newHashMap(); // Origami
+
     public AdvancementDataPlayer(DataFixer datafixer, PlayerList playerlist, AdvancementDataWorld advancementdataworld, File file, EntityPlayer entityplayer) {
         this.d = datafixer;
         this.e = playerlist;
diff --git a/src/main/java/net/minecraft/server/CriterionTriggerAbstract.java b/src/main/java/net/minecraft/server/CriterionTriggerAbstract.java
index 2419c57f90f40516cb4b4cedcda2c7d58523c3bc..5cec746fe45f0d4e60ff444156742ae64f2e1c9c 100644
--- a/src/main/java/net/minecraft/server/CriterionTriggerAbstract.java
+++ b/src/main/java/net/minecraft/server/CriterionTriggerAbstract.java
@@ -12,25 +12,25 @@ import java.util.function.Predicate;
 
 public abstract class CriterionTriggerAbstract<T extends CriterionInstanceAbstract> implements CriterionTrigger<T> {
 
-    private final Map<AdvancementDataPlayer, Set<CriterionTrigger.a<T>>> a = Maps.newIdentityHashMap();
+    //private final Map<AdvancementDataPlayer, Set<CriterionTrigger.a<T>>> a = Maps.newIdentityHashMap(); // Origami
 
     public CriterionTriggerAbstract() {}
 
     @Override
     public final void a(AdvancementDataPlayer advancementdataplayer, CriterionTrigger.a<T> criteriontrigger_a) {
-        ((Set) this.a.computeIfAbsent(advancementdataplayer, (advancementdataplayer1) -> {
+        (advancementdataplayer.criterionData.computeIfAbsent(this, (advancementdataplayer1) -> { // Origami
             return Sets.newHashSet();
         })).add(criteriontrigger_a);
     }
 
     @Override
     public final void b(AdvancementDataPlayer advancementdataplayer, CriterionTrigger.a<T> criteriontrigger_a) {
-        Set<CriterionTrigger.a<T>> set = (Set) this.a.get(advancementdataplayer);
+        Set<CriterionTrigger.a<T>> set = (Set) advancementdataplayer.criterionData.get(this); // Origami
 
         if (set != null) {
             set.remove(criteriontrigger_a);
             if (set.isEmpty()) {
-                this.a.remove(advancementdataplayer);
+                advancementdataplayer.criterionData.remove(this); // Origami
             }
         }
 
@@ -38,7 +38,7 @@ public abstract class CriterionTriggerAbstract<T extends CriterionInstanceAbstra
 
     @Override
     public final void a(AdvancementDataPlayer advancementdataplayer) {
-        this.a.remove(advancementdataplayer);
+        advancementdataplayer.criterionData.remove(this); // Origami
     }
 
     protected abstract T b(JsonObject jsonobject, CriterionConditionEntity.b criterionconditionentity_b, LootDeserializationContext lootdeserializationcontext);
@@ -52,7 +52,7 @@ public abstract class CriterionTriggerAbstract<T extends CriterionInstanceAbstra
 
     protected void a(EntityPlayer entityplayer, Predicate<T> predicate) {
         AdvancementDataPlayer advancementdataplayer = entityplayer.getAdvancementData();
-        Set<CriterionTrigger.a<T>> set = (Set) this.a.get(advancementdataplayer);
+        Set<CriterionTrigger.a<T>> set = (Set) advancementdataplayer.criterionData.get(this); // Origami
 
         if (set != null && !set.isEmpty()) {
             LootTableInfo loottableinfo = CriterionConditionEntity.b(entityplayer, entityplayer);
@@ -63,7 +63,7 @@ public abstract class CriterionTriggerAbstract<T extends CriterionInstanceAbstra
 
             while (iterator.hasNext()) {
                 criteriontrigger_a = (CriterionTrigger.a) iterator.next();
-                T t0 = (CriterionInstanceAbstract) criteriontrigger_a.a();
+                T t0 = (T) criteriontrigger_a.a(); // Origami - decompile fix
 
                 if (t0.b().a(loottableinfo) && predicate.test(t0)) {
                     if (list == null) {
